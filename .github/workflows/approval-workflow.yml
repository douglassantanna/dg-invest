name: CI/CD with Approval Steps

on:
  pull_request:
    branches:
      - stage  # Trigger the workflow when merging into stage

  workflow_dispatch:
    # Allow manual trigger of the workflow if needed

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.x"

      - name: Restore dependencies
        run: dotnet restore api/dg-invest.api.sln

      - name: Build the project
        run: dotnet build api/dg-invest.api.sln --no-restore --configuration Release

      - name: Run backend tests
        run: dotnet test api/dg-invest.api.sln --no-build --configuration Release --verbosity normal

      # Add your frontend tests step here
      # - name: Run frontend tests
      #   run: npm run test --prefix ./web-app

  deploy_to_stage:
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: Staging
      url: 'https://gentle-sea-021fa1c03.5.azurestaticapps.net/#/login'
    if: github.event_name == 'pull_request' && github.base_ref == 'staging'
    steps:
      - name: Approval required before merging into stage
        run: echo "Deploying to stage environment..."  # Replace with your stage deployment script

  deploy_to_production:
    runs-on: ubuntu-latest
    needs: deploy_to_stage
    environment:
      name: Production
      url: 'https://red-rock-0ee91e910.4.azurestaticapps.net/#/login'
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    steps:
      - name: Approval required before merging into master
        run: echo "Deploying to production environment..."  # Replace with your production deployment script
